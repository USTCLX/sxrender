!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.SXRender=i()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(t){var i,s,e;return i=t.clientX,s=t.clientY,e=t.target.getBoundingClientRect(),{x:Math.round(i-e.x),y:Math.round(s-e.y)}},s=function(t,i,s){for(var e=null,n=i,h=0,a=t.length;h<a;h++)if(!0===(e=t[h]).draggable)switch(e.type){case"ball":if(n.x>e.x+s.x-e.radius&&n.x<e.x+s.x+e.radius&&n.y>e.y+s.y-e.radius&&n.y<e.y+s.y+e.radius)return e.id;break;case"rect":if(n.x>e.x+s.x&&n.x<e.x+s.x+e.w&&n.y>e.y+s.y&&n.y<e.y+s.y+e.h)return e.id;break;case"image":return e.id;default:return 0}},e=function(t,i){return t>0?Math.round((1-1/(.55*t/i+1))*i):-Math.round((1-1/(.55*-t/i+1))*i)};function n(t,i){setTimeout(t,i)}var h={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},spring:function(t){return-.5*Math.exp(-6*t)*(-2*Math.exp(6*t)+Math.sin(12*t)+2*Math.cos(12*t))}},a={idle:"idle",running:"running",paused:"paused"};function r(t,i,s){return Math.round(t+s*(i-t))}function o(t,i,s){var e=Object.assign({},t);for(var n in e)e.hasOwnProperty(n)&&(e[n]=Math.round(t[n]+s*(i[n]-t[n])));return e}var u=function(t,i,s,e,n,r){r=r||{},this.target=t,this.key=i,this.startValue=s,this.stopValue=e,this.duration=n,this.fps=r.fps||60,this.startDelay=r.startDelay||0,this.autoReverse=r.autoReverse||!1,this.repeatCount=r.repeatCount||1,this.appliedOnCompletion=r.appliedOnCompletion||function(){},this.timingFun=r.timingFun||h.linear,this.state=new function(t,i,s,e){this.stateType=t||a.idle,this.repeat=i||0,this.curFrame=s||0,this.curValue=e},this.lastState=null,this.didStartCB=r.didStartCB||function(){},this.onFrameCB=r.onFrameCB||function(){},this.didPauseCB=r.didPauseCB||function(){},this.didStopCB=r.didStopCB||function(){},this._p=0,this._totalFrames=0,this._timeStep=0,this._timeStamp=0,this.init()},c=function i(){this.state.stateType===a.running&&(this._p=this.timingFun(this.state.curFrame/this._totalFrames),this.state.curValue="object"!==t(this.startValue)?r(this.startValue,this.stopValue,this._p):o(this.startValue,this.stopValue,this._p),this.target.hasOwnProperty(this.key)&&(this.target[this.key]=this.state.curValue),this.onFrameCB&&this.onFrameCB(),this.state.curFrame<this._totalFrames?n(i.bind(this),this._timeStep):this.stop(),this.state.curFrame++)};u.prototype={constructor:u,init:function(){this._totalFrames=this.duration/1e3*this.fps,this._timeStep=Math.round(1/this.fps)},start:function(){this.state.stateType===a.idle&&(this.state.stateType=a.running,setTimeout(function(){this.didStartCB&&this.didStartCB(),n(c.bind(this),this._timeStep)}.bind(this),this.startDelay))},stop:function(){this.state.stateType=a.idle,this.state.curValue=0,this.state.curFrame=0,this._totalFrames=0,this.didStopCB&&this.didStopCB()},pause:function(){this.state.stateType===a.running&&(this.state.stateType=a.paused,this.didPauseCB&&this.didPauseCB())},resume:function(){this.state.stateType===a.paused&&(this.state.stateTypes=a.running,n(c.bind(this),this._timeStep))}};var d=function(t,i,s,e,n,h,a,r,o){u.apply(this,[t,i,h,a,r]),this.initialVelocity=s||0,this.damping=e||12,this.stiffness=n||180,this.startX=o||0};d.prototype=Object.create(u.prototype);Object.assign(d.prototype,{constructor:d,start:function(){var i,s,e,h,u,c,d,m,f,l,y,g,x,p;this.state.stateType===a.idle&&(this.state.stateType=a.running,this.timingFun=(i=this.damping,s=this.stiffness,e=this.initialVelocity,h=this.startX,p=(x=i)*x-4*s,f=(h||0)-1,l=e,p>0?(p=Math.sqrt(p),y=(l-(c=.5*(-x-p))*f)/((u=.5*(-x+p))-c),g=(l-u*f)/(c-u),function(t){return y*Math.exp(u*t)+g*Math.exp(c*t)+1}):0==p?(g=l-(y=f)*(u=.5*-x),function(t){return(y+g*t)*Math.exp(u*t)+1}):(p=Math.sqrt(-p),y=f,g=(l-(d=.5*-x)*f)/(m=.5*p),function(t){return(y*Math.cos(m*t)+g*Math.sin(m*t))*Math.exp(d*t)+1})),setTimeout(function(){this.didStartCB&&this.didStartCB(),this._timeStamp=Date.now(),n(function i(){this.state.stateType===a.running&&(this._p=this.timingFun(this.state.curFrame/this._totalFrames),this.state.curValue="object"!==t(this.startValue)?r(this.startValue,this.stopValue,this._p):o(this.startValue,this.stopValue,this._p),this.target&&this.target.hasOwnProperty(this.key)&&(this.target[this.key]=this.state.curValue),this.onFrameCB&&this.onFrameCB(),this.state.curFrame<this._totalFrames?n(i.bind(this),this._timeStep):(this.state.curFrame=this.stopValue,this.stop()),this.state.curFrame++)}.bind(this),this._timeStep)}.bind(this),this.startDelay))}});var m=function(t,i,s,e,n,h){u.apply(this,[t,i,s,e,null,h]),this.amplitude=n,this.init()},f=function(i,s,e){if("object"===(void 0===i?"undefined":t(i))){var n={};for(var h in i)i.hasOwnProperty(h)&&(n[h]=i[h]-s[h]*Math.exp(-e/500));return n}return i-s*Math.exp(-e/500)};m.prototype=Object.create(u.prototype),Object.assign(m.prototype,{constructor:m,init:function(){this._timeStep=1/this.fps},start:function(){this.state.stateType===a.idle&&(this.state.stateType=a.running,setTimeout(function(){this.didStartCB&&this.didStartCB(),this._timeStamp=Date.now(),n(function t(){var i=Date.now()-this._timeStamp,s=this.state;this.state.stateType===a.running&&(s.curValue=f(this.stopValue,this.amplitude,i),Math.abs(this.stopValue-s.curValue)<1?(s.curValue=this.stopValue,this.onFrameCB&&this.onFrameCB(),this.stop()):(this.onFrameCB&&this.onFrameCB(),n(t.bind(this),this._timeStep)))}.bind(this),this._timeStep)}.bind(this),this.startDelay))}});var l=function(t){var i,s,e,n,h,a,r,o,u;e=(t=t||{}).id||"",n=t.w,h=t.h,a=t.backgroundColor||"",r=t.contentW||n,o=t.contentH||h,u=t.drawScrollBar||!1,(i=e?document.getElementById(e):document.createElement("canvas")).style.backgroundColor=a||"rgba(0,0,0,0)",i.width=n||500,i.height=h||500,s=i.getContext("2d"),this.init(i,s,r,o,u)};function y(t){if(this.dragging)this.dragging=!1,this.selectObjId=0;else if(this.scratching&&(this.scratching=!1,clearInterval(this._ticker),this.scrollVEnabled||this.scrollHEnabled))if(0!==this.springOffset.y||0!==this.springOffset.x){var i=this;this._animation=new d(null,"",0,12,180,this.springOffset,{x:0,y:0},2e3),this._animation.onFrameCB=function(){i.springOffset=this.state.curValue,i.reRender()},this._animation.start()}else{var s={},e={},n=this._contentVelcoity;if(n.y>30||n.y<-30||n.x>30||n.x<-30){s.x=n.x<-30||n.x>30?.8*n.x:0,s.y=n.y<-30||n.y>30?.8*n.y:0,e.x=Math.round(this.contentOffset.x+s.x),e.y=Math.round(this.contentOffset.y+s.y);i=this;this._animation=new m(null,"",this.contentOffset,e,s),this._animation.onFrameCB=function(){var t,s=!1,e=!1;i.contentOffset=this.state.curValue,((t=i.contentOffset).x>i.limitX.max||t.x<i.limitX.min)&&(t.x=t.x>i.limitX.max?i.limitX.max:i.limitX.min,s=!0),(t.y>i.limitY.max||t.y<i.limitY.min)&&(t.y=t.y>i.limitY.max?i.limitY.max:i.limitY.min,e=!0),s&&e&&this.stop(),i.reRender()},this._animation.start()}}}return l.prototype={constructor:l,init:function(t,n,h,a,r){this.canvas=t,this.ctx=n,this.width=t.width,this.height=t.height,this.dragging=!1,this.scratching=!1,this.selectObjId=0,this.contentW=h,this.contentH=a,this.drawScrollBar=r,this.backgroundImg={},this.scrollVEnabled=!!(this.contentH&&this.contentH>this.height),this.scrollHEnabled=!!(this.contentW&&this.contentW>this.width),this.limitX={min:this.width-this.contentW,max:0},this.limitY={min:this.height-this.contentH,max:0},this.mouseDownPos={x:0,y:0},this.springOffset={x:0,y:0},this.contentOffset={x:0,y:0},this.objs=[],this._animation=null,this._contentVelcoity={y:0,x:0},this._frame={x:0,y:0},this._ticker=null,this._timeStamp=0,this.canvas.addEventListener("mousedown",function(t){var e=i(t);this.selectObjId=s(this.objs,e,this.contentOffset),this.mouseDownPos=e,this.selectObjId?this.dragging=!0:(this.scratching=!0,this._animation&&this._animation.stop(),clearInterval(this._ticker),this._contentVelcoity.y=0,this._contentVelcoity.x=0,(this.scrollVEnabled||this.scrollHEnabled)&&(this._timeStamp=Date.now(),this._frame.y=this.mouseDownPos.y,this._frame.x=this.mouseDownPos.x,this._ticker=setInterval(function(){var t,i,s,e;t=Date.now(),i=t-this._timeStamp,this._timeStamp=t,s=this.mouseDownPos.y-this._frame.y,e=1e3*s/(1+i),this._contentVelcoity.y=.8*e+.2*this._contentVelcoity.y,s=this.mouseDownPos.x-this._frame.x,e=1e3*s/(1+i),this._contentVelcoity.x=.8*e+.2*this._contentVelcoity.x,this._frame.y=this.mouseDownPos.y,this._frame.x=this.mouseDownPos.x}.bind(this),50)))}.bind(this),!1),this.canvas.addEventListener("mouseup",y.bind(this),!1),this.canvas.addEventListener("mousemove",function(t){var s,n,h={x:0,y:0};n=i(t),this.dragging?(h.x=n.x-this.mouseDownPos.x,h.y=n.y-this.mouseDownPos.y,this.mouseDownPos.x=n.x,this.mouseDownPos.y=n.y,(s=this.findObjById(this.selectObjId)).x+=h.x,s.y+=h.y,this.reRender()):this.scratching&&(this.scrollVEnabled||this.scrollHEnabled)&&(h.x=n.x-this.mouseDownPos.x,h.y=n.y-this.mouseDownPos.y,this.scrollVEnabled&&(h.y<0?this.contentOffset.y<=this.limitY.min?(this.contentOffset.y=this.limitY.min,this.springOffset.y=e(h.y,this.height)):(this.mouseDownPos.y=n.y,this.contentOffset.y+=h.y):this.contentOffset.y>=this.limitY.max?(this.contentOffset.y=this.limitY.max,this.springOffset.y=e(h.y,this.height)):(this.mouseDownPos.y=n.y,this.contentOffset.y+=h.y)),this.scrollHEnabled&&(h.x<0?this.contentOffset.x<=this.limitX.min?(this.contentOffset.x=this.limitX.min,this.springOffset.x=e(h.x,this.width)):(this.mouseDownPos.x=n.x,this.contentOffset.x+=h.x):this.contentOffset.x>=this.limitX.max?(this.contentOffset.x=this.limitX.max,this.springOffset.x=e(h.x,this.width)):(this.mouseDownPos.x=n.x,this.contentOffset.x+=h.x)),this.reRender())}.bind(this),!1),this.canvas.addEventListener("mouseout",y.bind(this),!1)},drawBackground:function(t){t&&(this.backgroundImg.content=t.imgObj,this.backgroundImg.sx=t.sx||0,this.backgroundImg.sy=t.sy||0,this.backgroundImg.sw=t.sw||0,this.backgroundImg.sh=t.sh||0,this.backgroundImg.dx=t.dx||0,this.backgroundImg.dy=t.dy||0,this.backgroundImg.dw=t.dw||this.width,this.backgroundImg.dh=t.dh||this.height),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.backgroundImg.content&&(this.backgroundImg.sw&&this.backgroundImg.sh?this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.sx,this.backgroundImg.sy,this.backgroundImg.sw,this.backgroundImg.sh,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh):this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh),this.ctx.restore())},drawBall:function(t){t=t||{};var i,s,e,n,h=0*Math.PI,a=2*Math.PI;i=t.x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.radius,n=t.color,this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=n,this.ctx.arc(i,s,e,h,a,!1),this.ctx.fill(),this.ctx.closePath(),this.ctx.restore()},clearCtx:function(t){var i,s,e,n;i=(t=t||{}).x||0,s=t.y||0,e=t.w||this.width,n=t.h||this.height,this.ctx.clearRect(i,s,e,n)},drawRect:function(t){var i,s,e,n,h;i=(t=t||{}).x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.w,n=t.h,h=t.color,this.ctx.save(),this.ctx.fillStyle=h,this.ctx.fillRect(i,s,e,n),this.ctx.restore()},drawImage:function(t){var i,s,e,n,h,a,r,o,u;i=(t=t||{}).imgObj,s=t.x||0,e=t.y||0,n=t.w,h=t.h,a=t.dx||0,r=t.dy||0,o=t.dw||0,u=t.dh||0,this.ctx.save(),o&&u?this.ctx.drawImage(i,s,e,n,h,a,r,o,u):n&&h?(s+=this.springOffset.x,e+=this.springOffset.y,this.ctx.drawImage(i,s,e,n,h)):this.ctx.drawImage(i,s,e),this.ctx.restore()},reRender:function(){this.clearCtx(),this.backgroundImg.content&&this.drawBackground(),this.ctx.setTransform(1,0,0,1,this.contentOffset.x,this.contentOffset.y);for(var t=this.objs||[],i=0,s=t.length;i<s;i++)switch(t[i].type){case"ball":this.drawBall(t[i]);break;case"rect":this.drawRect(t[i]);break;case"image":this.drawImage(t[i]);break;default:console.log("miss in reRender")}this.ctx.setTransform(1,0,0,1,0,0)},findObjById:function(t){for(var i=0,s=this.objs.length;i<s;i++)if(this.objs[i].id===t)return this.objs[i];return null},add:function(t){var i={};i=Object.assign(i,t,{id:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxx".replace(/[xy]/g,function(t){var i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)}).toUpperCase()}),this.objs.push(i)},_drawProgress:function(){var t,i,s,e;e=this.springOffset.y>0?-this.springOffset.y:-2*this.springOffset.y,s=(s=Math.round(this.height*this.height/this.contentH)-Math.abs(this.springOffset.y))<10?10:s,t=Math.round(-this.contentOffset.y*this.height/this.contentH)+e,i=this.width-4,this.drawRect({x:i,y:t,w:4,h:s,color:"#888888"})}},l});