!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.SXRender=i()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(t){var i,s,e;return i=t.clientX,s=t.clientY,e=t.target.getBoundingClientRect(),{x:Math.round(i-e.x),y:Math.round(s-e.y)}},s=function(t,i,s){for(var e=null,n=i,a=0,h=t.length;a<h;a++)if(!0===(e=t[a]).draggable)switch(e.type){case"ball":if(n.x>e.x+s.x-e.radius&&n.x<e.x+s.x+e.radius&&n.y>e.y+s.y-e.radius&&n.y<e.y+s.y+e.radius)return e.id;break;case"rect":if(n.x>e.x+s.x&&n.x<e.x+s.x+e.w&&n.y>e.y+s.y&&n.y<e.y+s.y+e.h)return e.id;break;case"image":return e.id;default:return 0}},e=function(t,i){return t>0?Math.round((1-1/(.55*t/i+1))*i):-Math.round((1-1/(.55*-t/i+1))*i)},n=function i(s){var e;if(null===s||"object"!==(void 0===s?"undefined":t(s)))return s;if(s instanceof Date)return(e=new Date).setTime(s.getTime()),e;if(s instanceof Array){e=[];for(var n=0,a=s.length;n<a;n++)e[n]=i(s[n]);return e}if(s instanceof Object){e={};for(var h in s)s.hasOwnProperty(h)&&(e[h]=i(s[h]));return e}};function a(t,i){setTimeout(t,i)}var h={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},spring:function(t){return-.5*Math.exp(-6*t)*(-2*Math.exp(6*t)+Math.sin(12*t)+2*Math.cos(12*t))}},r={idle:"idle",running:"running",paused:"paused"},o="number",u="object";function c(t,i,s){return Math.round(t+s*(i-t))}function l(t,i,s){var e=Object.assign({},t);for(var n in e)e.hasOwnProperty(n)&&(e[n]=Math.round(t[n]+s*(i[n]-t[n])));return e}var d=function(t,i,s,e,n,a){a=a||{},this.target=t,this.key=i,this.startValue=s,this.stopValue=e,this.duration=n,this.fps=a.fps||60,this.startDelay=a.startDelay||0,this.autoReverse=a.autoReverse||!1,this.repeatCount=a.repeatCount||1,this.appliedOnCompletion=a.appliedOnCompletion||function(){},this.timingFun=a.timingFun||h.linear,this.state=new function(t,i,s,e){this.stateType=t||r.idle,this.repeat=i||0,this.curFrame=s||0,this.curValue=e},this.lastState=null,this.didStartCB=a.didStartCB||function(){},this.onFrameCB=a.onFrameCB||function(){},this.didPauseCB=a.didPauseCB||function(){},this.didStopCB=a.didStopCB||function(){},this._p=0,this._totalFrames=0,this._timeStep=0,this._timeStamp=0,this._lastTimeStamp=0,this._valueType=o,this.init()},f=function t(){this.state.stateType===r.running&&(this._p=this.timingFun(this.state.curFrame/this._totalFrames),this.state.curValue=this._valueType!==u?c(this.startValue,this.stopValue,this._p):l(this.startValue,this.stopValue,this._p),this.target.hasOwnProperty(this.key)&&(this.target[this.key]=this.state.curValue),this.onFrameCB&&this.onFrameCB(),this.lastState=n(this.state),this._lastTimeStamp=Date.now(),this.state.curFrame<this._totalFrames?a(t.bind(this),this._timeStep):(this.state.curValue=this.stopValue,this.didStopCB&&this.didStopCB(),this.stop()),this.state.curFrame++)};d.prototype={constructor:d,init:function(){switch(this._totalFrames=this.duration/1e3*this.fps,this._timeStep=Math.round(1/this.fps),t(this.startValue)){case"object":this._valueType=u;break;case"number":this._valueType=o}this.state.curValue=n(this.startValue)},start:function(){this.state.stateType===r.idle&&(this.state.stateType=r.running,setTimeout(function(){this.didStartCB&&this.didStartCB(),this._lastTimeStamp=Date.now(),this.lastState=n(this.state),a(f.bind(this),this._timeStep)}.bind(this),this.startDelay))},stop:function(){this.state.stateType=r.idle,this.state.curValue=0,this.state.curFrame=0,this._totalFrames=0,this.didStopCB&&this.didStopCB()},pause:function(){this.state.stateType===r.running&&(this.state.stateType=r.paused,this.didPauseCB&&this.didPauseCB())},resume:function(){this.state.stateType===r.paused&&(this.state.stateTypes=r.running,a(f.bind(this),this._timeStep))}};var m=function(t,i,s,e,n,a,h,r,o){d.apply(this,[t,i,a,h,r]),this.initialVelocity=s||0,this.damping=e||12,this.stiffness=n||180,this.startX=o||0};m.prototype=Object.create(d.prototype);Object.assign(m.prototype,{constructor:m,start:function(){var t,i,s,e,n,h,o,d,f,m,p,y,x,g;this.state.stateType===r.idle&&(this.state.stateType=r.running,this.timingFun=(t=this.damping,i=this.stiffness,s=this.initialVelocity,e=this.startX,g=(x=t)*x-4*i,f=(e||0)-1,m=s,g>0?(g=Math.sqrt(g),p=(m-(h=.5*(-x-g))*f)/((n=.5*(-x+g))-h),y=(m-n*f)/(h-n),function(t){return p*Math.exp(n*t)+y*Math.exp(h*t)+1}):0==g?(y=m-(p=f)*(n=.5*-x),function(t){return(p+y*t)*Math.exp(n*t)+1}):(g=Math.sqrt(-g),p=f,y=(m-(o=.5*-x)*f)/(d=.5*g),function(t){return(p*Math.cos(d*t)+y*Math.sin(d*t))*Math.exp(o*t)+1})),setTimeout(function(){this.didStartCB&&this.didStartCB(),this._timeStamp=Date.now(),a(function t(){this.state.stateType===r.running&&(this._p=this.timingFun(this.state.curFrame/this._totalFrames),0===this.startX?this.state.curValue=this._valueType!==u?c(this.startValue,this.stopValue,this._p):l(this.startValue,this.stopValue,this._p):1===this.startX&&(this.state.curValue=this._p-1),this.target&&this.target.hasOwnProperty(this.key)&&(this.target[this.key]=this.state.curValue),this.onFrameCB&&this.onFrameCB(),this.state.curFrame<this._totalFrames?a(t.bind(this),this._timeStep):(this.state.curValue=this.stopValue,this.didStopCB&&this.didStopCB(),this.stop()),this.state.curFrame++)}.bind(this),this._timeStep)}.bind(this),this.startDelay))}});var p=function(t,i,s,e,n,a){d.apply(this,[t,i,s,e,null,a]),this.amplitude=n,this.init()},y=function(t,i,s,e){if(e===u){var n={};for(var a in t)t.hasOwnProperty(a)&&(n[a]=t[a]-i[a]*Math.exp(-s/500));return n}return t-i*Math.exp(-s/500)};p.prototype=Object.create(d.prototype),Object.assign(p.prototype,{constructor:p,start:function(){this.state.stateType===r.idle&&(this.state.stateType=r.running,setTimeout(function(){this.didStartCB&&this.didStartCB(),this._timeStamp=Date.now(),this._lastTimeStamp=Date.now(),this.lastState=n(this.state),a(function t(){var i=Date.now()-this._timeStamp,s=this.state;if(this.state.stateType===r.running){if(s.curValue=y(this.stopValue,this.amplitude,i,this._valueType),this._valueType===u){var e=0,h=0;for(var c in s.curValue)s.curValue.hasOwnProperty(c)&&(e++,Math.abs(this.stopValue[c]-s.curValue[c])<1&&(h++,s.curValue[c]=this.stopValue[c]));if(h===e)return this.onFrameCB&&this.onFrameCB(),void this.stop()}else if(this._valueType===o&&Math.abs(this.stopValue-s.curValue)<1)return s.curValue=this.stopValue,this.onFrameCB&&this.onFrameCB(),void this.stop();this.onFrameCB&&this.onFrameCB(),this._lastTimeStamp=Date.now(),this.lastState=n(this.state),a(t.bind(this),this._timeStep)}}.bind(this),this._timeStep)}.bind(this),this.startDelay))}});var x=function(t){var i,s,e,n,a,h,r,o,u;e=(t=t||{}).id||"",n=t.w,a=t.h,h=t.backgroundColor||"",r=t.contentW||n,o=t.contentH||a,u=t.drawScrollBar||!1,(i=e?document.getElementById(e):document.createElement("canvas")).style.backgroundColor=h||"rgba(0,0,0,0)",i.width=n||500,i.height=a||500,s=i.getContext("2d"),this.init(i,s,r,o,u)};function g(t){if(this.dragging)this.dragging=!1,this.selectObjId=0;else if(this.scratching&&(this.scratching=!1,clearInterval(this._ticker),this.scrollVEnabled||this.scrollHEnabled))if(0!==this.springOffset.y||0!==this.springOffset.x){var i=this;this._animation=new m(null,"",0,12,180,this.springOffset,{x:0,y:0},2e3),this._animation.onFrameCB=function(){i.springOffset=this.state.curValue,i.reRender()},this._animation.start()}else{var s={},e={},n=this._contentVelcoity;if(n.y>30||n.y<-30||n.x>30||n.x<-30){s.x=n.x<-30||n.x>30?.8*n.x:0,s.y=n.y<-30||n.y>30?.8*n.y:0,e.x=Math.round(this.contentOffset.x+s.x),e.y=Math.round(this.contentOffset.y+s.y);i=this;this._animation=new p(null,"",this.contentOffset,e,s),this._animation.onFrameCB=function(){var t,s=0,e=0;i.contentOffset=this.state.curValue,((t=i.contentOffset).x>i.limitX.max||t.x<i.limitX.min)&&(t.x=t.x>i.limitX.max?i.limitX.max:i.limitX.min,s=(this.state.curValue.x-this.lastState.curValue.x)/(Date.now()-this._lastTimeStamp)*1e3),(t.y>i.limitY.max||t.y<i.limitY.min)&&(t.y=t.y>i.limitY.max?i.limitY.max:i.limitY.min,e=(this.state.curValue.y-this.lastState.curValue.y)/(Date.now()-this._lastTimeStamp)*1e3),i.reRender(),(Math.abs(s)>50||Math.abs(e)>50&&(!s||!e))&&(this.stop(),Math.abs(e)>50?(i._animation=new m(null,"",e,20,180,0,0,2e3,1),i._animation.onFrameCB=function(){i.springOffset.y=this.state.curValue,i.reRender()},i._animation.didStopCB=function(){i.springOffset.y=this.state.curValue,i.reRender()},i._animation.start()):Math.abs(s)>50&&(i._animation=new m(null,"",s,20,180,0,0,2e3,1),i._animation.onFrameCB=function(){i.springOffset.x=this.state.curValue,i.reRender()},i._animation.didStopCB=function(){i.springOffset.x=this.state.curValue,i.reRender()},i._animation.start()))},this._animation.start()}}}return x.prototype={constructor:x,init:function(t,n,a,h,r){this.canvas=t,this.ctx=n,this.width=t.width,this.height=t.height,this.dragging=!1,this.scratching=!1,this.selectObjId=0,this.contentW=a,this.contentH=h,this.drawScrollBar=r,this.backgroundImg={},this.scrollVEnabled=!!(this.contentH&&this.contentH>this.height),this.scrollHEnabled=!!(this.contentW&&this.contentW>this.width),this.limitX={min:this.width-this.contentW,max:0},this.limitY={min:this.height-this.contentH,max:0},this.mouseDownPos={x:0,y:0},this.springOffset={x:0,y:0},this.contentOffset={x:0,y:0},this.objs=[],this._animation=null,this._contentVelcoity={y:0,x:0},this._frame={x:0,y:0},this._ticker=null,this._timeStamp=0,this.canvas.addEventListener("mousedown",function(t){var e=i(t);this.selectObjId=s(this.objs,e,this.contentOffset),this.mouseDownPos=e,this.selectObjId?this.dragging=!0:(this.scratching=!0,this._animation&&this._animation.stop(),clearInterval(this._ticker),this._contentVelcoity.y=0,this._contentVelcoity.x=0,(this.scrollVEnabled||this.scrollHEnabled)&&(this._timeStamp=Date.now(),this._frame.y=this.mouseDownPos.y,this._frame.x=this.mouseDownPos.x,this._ticker=setInterval(function(){var t,i,s,e;t=Date.now(),i=t-this._timeStamp,this._timeStamp=t,s=this.mouseDownPos.y-this._frame.y,e=1e3*s/(1+i),this._contentVelcoity.y=.8*e+.2*this._contentVelcoity.y,s=this.mouseDownPos.x-this._frame.x,e=1e3*s/(1+i),this._contentVelcoity.x=.8*e+.2*this._contentVelcoity.x,this._frame.y=this.mouseDownPos.y,this._frame.x=this.mouseDownPos.x}.bind(this),50)))}.bind(this),!1),this.canvas.addEventListener("mouseup",g.bind(this),!1),this.canvas.addEventListener("mousemove",function(t){var s,n,a={x:0,y:0};n=i(t),this.dragging?(a.x=n.x-this.mouseDownPos.x,a.y=n.y-this.mouseDownPos.y,this.mouseDownPos.x=n.x,this.mouseDownPos.y=n.y,(s=this.findObjById(this.selectObjId)).x+=a.x,s.y+=a.y,this.reRender()):this.scratching&&(this.scrollVEnabled||this.scrollHEnabled)&&(a.x=n.x-this.mouseDownPos.x,a.y=n.y-this.mouseDownPos.y,this.scrollVEnabled&&(a.y<0?this.contentOffset.y<=this.limitY.min?(this.contentOffset.y=this.limitY.min,this.springOffset.y=e(a.y,this.height)):(this.mouseDownPos.y=n.y,this.contentOffset.y+=a.y):this.contentOffset.y>=this.limitY.max?(this.contentOffset.y=this.limitY.max,this.springOffset.y=e(a.y,this.height)):(this.mouseDownPos.y=n.y,this.contentOffset.y+=a.y)),this.scrollHEnabled&&(a.x<0?this.contentOffset.x<=this.limitX.min?(this.contentOffset.x=this.limitX.min,this.springOffset.x=e(a.x,this.width)):(this.mouseDownPos.x=n.x,this.contentOffset.x+=a.x):this.contentOffset.x>=this.limitX.max?(this.contentOffset.x=this.limitX.max,this.springOffset.x=e(a.x,this.width)):(this.mouseDownPos.x=n.x,this.contentOffset.x+=a.x)),this.reRender())}.bind(this),!1),this.canvas.addEventListener("mouseout",g.bind(this),!1)},drawBackground:function(t){t&&(this.backgroundImg.content=t.imgObj,this.backgroundImg.sx=t.sx||0,this.backgroundImg.sy=t.sy||0,this.backgroundImg.sw=t.sw||0,this.backgroundImg.sh=t.sh||0,this.backgroundImg.dx=t.dx||0,this.backgroundImg.dy=t.dy||0,this.backgroundImg.dw=t.dw||this.width,this.backgroundImg.dh=t.dh||this.height),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.backgroundImg.content&&(this.backgroundImg.sw&&this.backgroundImg.sh?this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.sx,this.backgroundImg.sy,this.backgroundImg.sw,this.backgroundImg.sh,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh):this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh),this.ctx.restore())},drawBall:function(t){t=t||{};var i,s,e,n,a=0*Math.PI,h=2*Math.PI;i=t.x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.radius,n=t.color,this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=n,this.ctx.arc(i,s,e,a,h,!1),this.ctx.fill(),this.ctx.closePath(),this.ctx.restore()},clearCtx:function(t){var i,s,e,n;i=(t=t||{}).x||0,s=t.y||0,e=t.w||this.width,n=t.h||this.height,this.ctx.clearRect(i,s,e,n)},drawRect:function(t){var i,s,e,n,a;i=(t=t||{}).x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.w,n=t.h,a=t.color,this.ctx.save(),this.ctx.fillStyle=a,this.ctx.fillRect(i,s,e,n),this.ctx.restore()},drawImage:function(t){var i,s,e,n,a,h,r,o,u;i=(t=t||{}).imgObj,s=t.x||0,e=t.y||0,n=t.w,a=t.h,h=t.dx||0,r=t.dy||0,o=t.dw||0,u=t.dh||0,this.ctx.save(),o&&u?this.ctx.drawImage(i,s,e,n,a,h,r,o,u):n&&a?(s+=this.springOffset.x,e+=this.springOffset.y,this.ctx.drawImage(i,s,e,n,a)):this.ctx.drawImage(i,s,e),this.ctx.restore()},reRender:function(){this.clearCtx(),this.backgroundImg.content&&this.drawBackground(),this.ctx.setTransform(1,0,0,1,this.contentOffset.x,this.contentOffset.y);for(var t=this.objs||[],i=0,s=t.length;i<s;i++)switch(t[i].type){case"ball":this.drawBall(t[i]);break;case"rect":this.drawRect(t[i]);break;case"image":this.drawImage(t[i]);break;default:console.log("miss in reRender")}this.ctx.setTransform(1,0,0,1,0,0),(this.scrollHEnabled||this.scrollVEnabled&&this.drawScrollBar)&&this._drawProgress()},findObjById:function(t){for(var i=0,s=this.objs.length;i<s;i++)if(this.objs[i].id===t)return this.objs[i];return null},add:function(t){var i={};i=Object.assign(i,t,{id:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxx".replace(/[xy]/g,function(t){var i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)}).toUpperCase()}),this.objs.push(i)},_drawProgress:function(){var t,i,s,e,n;this.scrollVEnabled&&(s=4,e=(e=Math.round(this.height*this.height/this.contentH)-Math.abs(this.springOffset.y))<10?10:e,n=this.springOffset.y<0?this.springOffset.y:0,t=(t=Math.round(-this.contentOffset.y*this.height/this.contentH)-n)>this.height-10?this.height-10:t,i=this.width-s,this.ctx.save(),this.ctx.fillStyle="#888888",this.ctx.fillRect(i,t,s,e),this.ctx.restore()),this.scrollHEnabled&&(s=(s=Math.round(this.width*this.width/this.contentW)-Math.abs(this.springOffset.x))<10?10:s,e=4,t=this.height-e,n=this.springOffset.x<0?this.springOffset.x:0,i=Math.round(-this.contentOffset.x*this.width/this.contentW)-n,this.ctx.save(),this.ctx.fillStyle="#888888",this.ctx.fillRect(i,t,s,e),this.ctx.restore())}},x});