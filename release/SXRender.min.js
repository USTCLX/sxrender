!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.SXRender=i()}(this,function(){"use strict";var t=function(t){var i,s,e;return i=t.clientX,s=t.clientY,e=t.target.getBoundingClientRect(),{x:Math.round(i-e.x),y:Math.round(s-e.y)}},i=function(t,i,s){for(var e=null,n=i,h=0,a=t.length;h<a;h++)if(!0===(e=t[h]).draggable)switch(e.type){case"ball":if(n.x>e.x+s.x-e.radius&&n.x<e.x+s.x+e.radius&&n.y>e.y+s.y-e.radius&&n.y<e.y+s.y+e.radius)return e.id;break;case"rect":if(n.x>e.x+s.x&&n.x<e.x+s.x+e.w&&n.y>e.y+s.y&&n.y<e.y+s.y+e.h)return e.id;break;case"image":return e.id;default:return 0}},s=function(t,i){return t>0?Math.round((1-1/(.55*t/i+1))*i):-Math.round((1-1/(.55*-t/i+1))*i)};function e(t,i){setTimeout(t,i)}var n={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},spring:function(t){return-.5*Math.exp(-6*t)*(-2*Math.exp(6*t)+Math.sin(12*t)+2*Math.cos(12*t))}},h={idle:"idle",running:"running",paused:"paused"};function a(t,i,s){return Math.round(t+s*(i-t))}var r=function(t,i,s,e,a,r){r=r||{},this.target=t,this.key=i,this.startValue=s,this.stopValue=e,this.duration=a,this.fps=r.fps||60,this.startDelay=r.startDelay||0,this.autoReverse=r.autoReverse||!1,this.repeatCount=r.repeatCount||1,this.appliedOnCompletion=r.appliedOnCompletion||function(){},this.timingFun=r.timingFun||n.linear,this.state=new function(t,i,s,e){this.stateType=t||h.idle,this.repeat=i||0,this.curFrame=s||0,this.curValue=e},this.lastState=null,this.didStartCB=r.didStartCB||function(){},this.onFrameCB=r.onFrameCB||function(){},this.didPauseCB=r.didPauseCB||function(){},this.didStopCB=r.didStopCB||function(){},this._p=0,this._totalFrames=0,this._timeStep=0,this._timeStamp=0,this.init()};r.prototype={constructor:r,init:function(){this._totalFrames=this.duration/1e3*this.fps,this._timeStep=Math.round(1/this.fps)},start:function(){this.state.stateType===h.idle&&(this.state.stateType=h.running,setTimeout(function(){this.didStartCB&&this.didStartCB(),e(function t(){this.state.stateType===h.running&&(this._p=this.timingFun(this.state.curFrame/this._totalFrames),this.state.curValue=a(this.startValue,this.stopValue,this._p),this.target.hasOwnProperty(this.key)&&(this.target[this.key]=this.state.curValue),this.onFrameCB&&this.onFrameCB(),this.state.curFrame<this._totalFrames?e(t.bind(this),this._timeStep):this.stop(),this.state.curFrame++)}.bind(this),this._timeStep)}.bind(this),this.startDelay))},stop:function(){this.state.stateType=h.idle,this.state.curValue=0,this.state.curFrame=0,this._totalFrames=0}};var o=function(t,i,s,e,n,h){r.apply(this,[t,i,s,e,null,h]),this.amplitude=n,this.init()},c=function(t,i,s){return t-i*Math.exp(-s/500)};o.prototype=Object.create(r.prototype),Object.assign(o.prototype,{constructor:o,init:function(){this._timeStep=1/this.fps},start:function(){this.state.stateType===h.idle&&(this.state.stateType=h.running,setTimeout(function(){this.didStartCB&&this.didStartCB(),this._timeStamp=Date.now(),e(function t(){var i=Date.now()-this._timeStamp,s=this.state;this.state.stateType===h.running&&(s.curValue=c(this.stopValue,this.amplitude,i),Math.abs(this.stopValue-s.curValue)<1?(s.curValue=this.stopValue,this.onFrameCB&&this.onFrameCB(),this.stop()):(this.onFrameCB&&this.onFrameCB(),e(t.bind(this),this._timeStep)))}.bind(this),this._timeStep)}.bind(this),this.startDelay))}});var u=function(t,i,s,e,n,h,a,o,c){r.apply(this,[t,i,h,a,o]),this.initialVelocity=s||0,this.damping=e||12,this.stiffness=n||180,this.startX=c||0};u.prototype=Object.create(r.prototype);Object.assign(u.prototype,{constructor:u,start:function(){var t,i,s,n,r,o,c,u,d,f,g,m,y,l;this.state.stateType===h.idle&&(this.state.stateType=h.running,this.timingFun=(t=this.damping,i=this.stiffness,s=this.initialVelocity,n=this.startX,l=(y=t)*y-4*i,d=(n||0)-1,f=s,l>0?(l=Math.sqrt(l),g=(f-(o=.5*(-y-l))*d)/((r=.5*(-y+l))-o),m=(f-r*d)/(o-r),function(t){return g*Math.exp(r*t)+m*Math.exp(o*t)+1}):0==l?(m=f-(g=d)*(r=.5*-y),function(t){return(g+m*t)*Math.exp(r*t)+1}):(l=Math.sqrt(-l),g=d,m=(f-(c=.5*-y)*d)/(u=.5*l),function(t){return(g*Math.cos(u*t)+m*Math.sin(u*t))*Math.exp(c*t)+1})),setTimeout(function(){this.didStartCB&&this.didStartCB(),this._timeStamp=Date.now(),e(function t(){this.state.stateType===h.running&&(this._p=this.timingFun(this.state.curFrame/this._totalFrames),this.state.curValue=a(this.startValue,this.stopValue,this._p),this.target&&this.target.hasOwnProperty(this.key)&&(this.target[this.key]=this.state.curValue),this.onFrameCB&&this.onFrameCB(),this.state.curFrame<this._totalFrames?e(t.bind(this),this._timeStep):(this.state.curFrame=this.stopValue,this.stop()),this.state.curFrame++)}.bind(this),this._timeStep)}.bind(this),this.startDelay))}});var d=function(t){var i,s,e,n,h,a,r,o,c;e=(t=t||{}).id||"",n=t.w,h=t.h,a=t.backgroundColor||"",r=t.contentW||n,o=t.contentH||h,c=t.drawScrollBar||!1,(i=e?document.getElementById(e):document.createElement("canvas")).style.backgroundColor=a||"rgba(0,0,0,0)",i.width=n||500,i.height=h||500,s=i.getContext("2d"),this.init(i,s,r,o,c)};function f(t){if(this.dragging)this.dragging=!1,this.selectObjId=0;else if(this.scratching)if(this.scratching=!1,clearInterval(this._ticker),0!==this.springOffset.y){this._animation&&this._animation.stop();var i=this;this._animation=new u(null,"",0,12,180,this.springOffset.y,0,2e3),this._animation.onFrameCB=function(){i.springOffset.y=this.state.curValue,i.reRender()},this._animation.start()}else{var s;if(this._contentVelcoity.y>30||this._contentVelcoity.y<-30){s=.8*this._contentVelcoity.y,this._targetPos.y=Math.round(this.contentOffset.y+s);i=this;this._animation=new o(null,"",this.contentOffset.y,this._targetPos.y,s),this._animation.onFrameCB=function(){i.contentOffset.y>0?(i.contentOffset.y=0,i._animation.stop()):i.contentOffset.y<i.height-i.contentH?(i.contentOffset.y=i.height-i.contentH,i._animation.stop()):i.contentOffset.y=this.state.curValue,i.reRender()},this._animation.start()}}}return d.prototype={constructor:d,init:function(e,n,h,a,r){var o,c,u,d,g,m,y,l,p,x,b;this.canvas=e,this.ctx=n,this.width=e.width,this.height=e.height,this.dragging=!1,this.scratching=!1,this.selectObjId=0,this.contentW=h,this.contentH=a,this.drawScrollBar=r,this.backgroundImg={},this.mouseDownPos={x:0,y:0},this.springOffset={x:0,y:0},this.contentOffset={x:0,y:0},this.objs=[],this._springTimeFun=(b=(x=12)*x-4*180,m=(o||0)-1,y=0,b>0?(b=Math.sqrt(b),l=(y-(u=.5*(-x-b))*m)/((c=.5*(-x+b))-u),p=(y-c*m)/(u-c),function(t){return l*Math.exp(c*t)+p*Math.exp(u*t)+1}):0==b?(p=y-(l=m)*(c=.5*-x),function(t){return(l+p*t)*Math.exp(c*t)+1}):(b=Math.sqrt(-b),l=m,p=(y-(d=.5*-x)*m)/(g=.5*b),function(t){return(l*Math.cos(g*t)+p*Math.sin(g*t))*Math.exp(d*t)+1})),this._animation=null,this._contentVelcoity={y:0,x:0},this._frame={x:0,y:0},this._targetPos={x:0,y:0},this._ticker=null,this._timeStamp=0,this.canvas.addEventListener("mousedown",function(s){var e=t(s);this.selectObjId=i(this.objs,e,this.contentOffset),this.mouseDownPos=e,this.selectObjId?this.dragging=!0:(this.scratching=!0,this._animation&&this._animation.stop(),clearInterval(this._animation),clearInterval(this._ticker),this._contentVelcoity.y=0,this._contentVelcoity.x=0,this._timeStamp=Date.now(),this._frame.y=e.y,this._ticker=setInterval(function(){var t,i,s,e;t=Date.now(),i=t-this._timeStamp,this._timeStamp=t,s=this.mouseDownPos.y-this._frame.y,this._frame.y=this.mouseDownPos.y,e=1e3*s/(1+i),this._contentVelcoity.y=.8*e+.2*this._contentVelcoity.y}.bind(this),50))}.bind(this),!1),this.canvas.addEventListener("mouseup",f.bind(this),!1),this.canvas.addEventListener("mousemove",function(i){var e,n,h={x:0,y:0};n=t(i),this.dragging?(h.x=n.x-this.mouseDownPos.x,h.y=n.y-this.mouseDownPos.y,this.mouseDownPos.x=n.x,this.mouseDownPos.y=n.y,(e=this.findObjById(this.selectObjId)).x+=h.x,e.y+=h.y,this.reRender()):this.scratching&&(h.x=n.x-this.mouseDownPos.x,h.y=n.y-this.mouseDownPos.y,h.y<0?this.contentOffset.y<=this.height-this.contentH?(this.contentOffset.y=Math.floor(this.height-this.contentH),this.springOffset.y=s(h.y,this.height)):(this.mouseDownPos.x=n.x,this.mouseDownPos.y=n.y,this.contentOffset.y+=h.y):this.contentOffset.y>=0?(this.contentOffset.y=0,this.springOffset.y=s(h.y,this.height)):(this.mouseDownPos.x=n.x,this.mouseDownPos.y=n.y,this.contentOffset.y+=h.y),this.reRender())}.bind(this),!1),this.canvas.addEventListener("mouseout",f.bind(this),!1)},drawBackground:function(t){t&&(this.backgroundImg.content=t.imgObj,this.backgroundImg.sx=t.sx||0,this.backgroundImg.sy=t.sy||0,this.backgroundImg.sw=t.sw||0,this.backgroundImg.sh=t.sh||0,this.backgroundImg.dx=t.dx||0,this.backgroundImg.dy=t.dy||0,this.backgroundImg.dw=t.dw||this.width,this.backgroundImg.dh=t.dh||this.height),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.backgroundImg.content&&(this.backgroundImg.sw&&this.backgroundImg.sh?this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.sx,this.backgroundImg.sy,this.backgroundImg.sw,this.backgroundImg.sh,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh):this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh),this.ctx.restore())},drawBall:function(t){t=t||{};var i,s,e,n,h=0*Math.PI,a=2*Math.PI;i=t.x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.radius,n=t.color,this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=n,this.ctx.arc(i,s,e,h,a,!1),this.ctx.fill(),this.ctx.closePath(),this.ctx.restore()},clearCtx:function(t){var i,s,e,n;i=(t=t||{}).x||0,s=t.y||0,e=t.w||this.width,n=t.h||this.height,this.ctx.clearRect(i,s,e,n)},drawRect:function(t){var i,s,e,n,h;i=(t=t||{}).x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.w,n=t.h,h=t.color,this.ctx.save(),this.ctx.fillStyle=h,this.ctx.fillRect(i,s,e,n),this.ctx.restore()},drawImage:function(t){var i,s,e,n,h,a,r,o,c;i=(t=t||{}).imgObj,s=t.x||0,e=t.y||0,n=t.w,h=t.h,a=t.dx||0,r=t.dy||0,o=t.dw||0,c=t.dh||0,this.ctx.save(),o&&c?this.ctx.drawImage(i,s,e,n,h,a,r,o,c):n&&h?(s+=this.springOffset.x,e+=this.springOffset.y,this.ctx.drawImage(i,s,e,n,h)):this.ctx.drawImage(i,s,e),this.ctx.restore()},reRender:function(){this.clearCtx(),this.backgroundImg.content&&this.drawBackground(),this.ctx.setTransform(1,0,0,1,this.contentOffset.x,this.contentOffset.y);for(var t=this.objs||[],i=0,s=t.length;i<s;i++)switch(t[i].type){case"ball":this.drawBall(t[i]);break;case"rect":this.drawRect(t[i]);break;case"image":this.drawImage(t[i]);break;default:console.log("miss in reRender")}this.drawScrollBar&&this._drawProgress()},findObjById:function(t){for(var i=0,s=this.objs.length;i<s;i++)if(this.objs[i].id===t)return this.objs[i];return null},add:function(t){var i={};i=Object.assign(i,t,{id:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxx".replace(/[xy]/g,function(t){var i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)}).toUpperCase()}),this.objs.push(i)},_drawProgress:function(){var t,i,s,e;this.ctx.setTransform(1,0,0,1,0,0),e=this.springOffset.y>0?-this.springOffset.y:-2*this.springOffset.y,s=(s=Math.round(this.height*this.height/this.contentH)-Math.abs(this.springOffset.y))<10?10:s,t=Math.round(-this.contentOffset.y*this.height/this.contentH)+e,i=this.width-4,this.drawRect({x:i,y:t,w:4,h:s,color:"#888888"})}},d});